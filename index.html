<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>WebXR Thumbstick Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Bewegung & Drehung per Thumbsticks (Quest, Pico, WMR …)" />
  <!-- A-Frame 1.5.0 -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>

  <script>
    /*----------  Bewegung + Drehung per VR-Controller  ---------*/
    AFRAME.registerComponent('quest-controller-movement', {
      schema: {                // anpassbar im HTML:  move-speed="4" rotation-speed="3"
        moveSpeed:     {type: 'number', default: 3},   // m/s
        rotationSpeed: {type: 'number', default: 2}    // rad/s
      },

      init () {
        /* Achsen-State -------------------------------------------------- */
        this.axis = {lx: 0, ly: 0, rx: 0};   // linker Stick (x,y) | rechter Stick (x)

        /* Controller-Referenzen ---------------------------------------- */
        this.left  = null;
        this.right = null;

        /* Abfangen, wenn Controller verbunden wird */
        this.el.sceneEl.addEventListener('controllerconnected', e => {
          const hand = e.detail.component.data.hand;
          if (hand === 'left')  this.left  = e.detail.target;
          if (hand === 'right') this.right = e.detail.target;
        });

        /* Thumbstick-Bewegungen ---------------------------------------- */
        this.el.sceneEl.addEventListener('thumbstickmoved', e => {
          const {x, y} = e.detail;
          if (e.target === this.left)  { this.axis.lx =  x; this.axis.ly =  y; }
          if (e.target === this.right) { this.axis.rx =  x; }
        });
      },

      tick (t, dtMs) {
        if (!this.left || !this.right) return;         // Controller noch nicht da
        const dt   = dtMs / 1000;
        const dead = 0.15;                             // Dead-Zone

        /* -------- Translation (linker Stick) -------- */
        const lx = Math.abs(this.axis.lx) > dead ? this.axis.lx : 0;
        const ly = Math.abs(this.axis.ly) > dead ? this.axis.ly : 0;

        if (lx !== 0 || ly !== 0) {
          const yaw   = this.el.object3D.rotation.y;       // Blickrichtung
          const speed = this.data.moveSpeed * dt;

          // vor/zurück relativ zur Blickrichtung
          const forward = new THREE.Vector3(
            Math.sin(yaw), 0, Math.cos(yaw)
          ).multiplyScalar(-ly * speed);

          // rechts/links relativ zur Blickrichtung
          const strafe = new THREE.Vector3(
            Math.cos(yaw), 0, -Math.sin(yaw)
          ).multiplyScalar(lx * speed);

          this.el.object3D.position.add(forward.add(strafe));
        }

        /* -------- Rotation (rechter Stick) ---------- */
        const rx = Math.abs(this.axis.rx) > dead ? this.axis.rx : 0;
        if (rx !== 0) {
          this.el.object3D.rotation.y -= rx * this.data.rotationSpeed * dt;
        }
      }
    });
  </script>
</head>

<body style="margin:0; background:#000">
  <a-scene
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    xr-mode-ui="enabled: true"
    background="color: #ECECEC">

    <!-- Boden ----------------------------------------------------- -->
    <a-plane color="#7BC8A4" width="50" height="50" rotation="-90 0 0"></a-plane>

    <!-- Testobjekte in der Szene ---------------------------------- -->
    <a-box position="0 1 -3"  depth="1" height="1" width="1"   color="#4CC3D9"></a-box>
    <a-sphere position="2 1.25 -5" radius="1.25"                 color="#EF2D5E"></a-sphere>
    <a-cylinder position="-2 0.75 -5" radius="0.5" height="1.5"  color="#FFC65D"></a-cylinder>

    <!-- Kamera-Rig mit Movement-Komponente ------------------------ -->
    <a-entity id="rig" quest-controller-movement>
      <a-entity camera position="0 1.6 0"></a-entity>

      <!-- Controller-Entities (emittieren thumbstickmoved) -------- -->
      <a-entity hand-controls="hand: left;  handModelStyle: lowpoly; color: #ffdddd"></a-entity>
      <a-entity hand-controls="hand: right; handModelStyle: lowpoly; color: #ddddff"></a-entity>
    </a-entity>

  </a-scene>
</body>
</html>
